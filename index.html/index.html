<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFT Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { 
                extend: { 
                    colors: { 
                        dark: { 900: '#0f172a', 800: '#1e293b', 700: '#334155' }
                    } 
                } 
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }

        .panel { transition: all 0.3s ease; }
        .light body { background-color: #f1f5f9; color: #0f172a; }
        .dark body { background-color: #0f172a; color: #f8fafc; }
        
        .light .panel { background: white; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .dark .panel { background: #1e293b; border: 1px solid #334155; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3); }

        .gold-card { background: linear-gradient(135deg, #FFD700 0%, #FDB931 100%); color: #5c4d00; }
        .dark .gold-card { background: linear-gradient(135deg, #B8860B 0%, #8B6508 100%); color: #fff; }

        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="overflow-hidden h-screen flex flex-col">

    <header class="bg-[#0f172a] text-white flex-shrink-0 z-50 shadow-md">
        <div class="h-16 px-6 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center shadow-lg shadow-blue-500/30">
                    <i class="fas fa-chart-simple text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold leading-tight tracking-wide">FFT Dashboard</h1>
                    <p class="text-xs text-slate-400 font-medium">Fulfillment Air Agents</p>
                </div>
            </div>

            <div class="hidden md:block flex-1 max-w-md mx-8">
                <div class="relative group">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-slate-500 group-focus-within:text-blue-400 transition"></i>
                    </div>
                    <input type="text" id="search-input" onkeyup="renderDashboard()" 
                        class="block w-full pl-10 pr-3 py-2 border border-slate-700 rounded-lg leading-5 bg-slate-800 text-slate-200 placeholder-slate-500 focus:outline-none focus:bg-slate-900 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-colors" 
                        placeholder="Search agents, TLs...">
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="hidden lg:flex items-center bg-slate-800 rounded-full px-3 py-1.5 border border-slate-700">
                    <i class="far fa-clock text-slate-400 text-xs mr-2"></i>
                    <span class="text-xs text-slate-300 font-mono" id="last-updated">Syncing...</span>
                </div>
                <button onclick="fetchData()" class="p-2 text-slate-400 hover:text-white transition"><i class="fas fa-sync-alt" id="refresh-icon"></i></button>
                <button onclick="toggleTheme()" class="p-2 text-slate-400 hover:text-yellow-400 transition"><i class="fas fa-sun" id="theme-icon"></i></button>
            </div>
        </div>
    </header>

    <div class="md:hidden bg-[#0f172a] px-6 pb-4 border-b border-slate-800">
        <input type="text" onkeyup="renderDashboard()" id="mobile-search" class="block w-full px-4 py-2 border border-slate-700 rounded-lg bg-slate-800 text-slate-200 placeholder-slate-500 focus:outline-none focus:border-blue-500 sm:text-sm" placeholder="Search agents...">
    </div>

    <main class="flex-1 overflow-y-auto relative scroll-smooth bg-gray-50 dark:bg-[#0b1120]">
        <div class="p-6 max-w-[1920px] mx-auto space-y-6">
            
            <div id="status-area" class="flex flex-col items-center justify-center h-[60vh]">
                <div class="loader mb-4"></div>
                <p class="text-sm font-medium text-slate-500 animate-pulse">Syncing with Google Sheets...</p>
            </div>

            <!-- DASHBOARD VIEW -->
            <div id="view-dashboard" class="hidden space-y-6">
                <div class="flex items-center gap-2 mb-2">
                    <i class="fas fa-chart-line text-blue-500"></i>
                    <h2 class="text-xl font-bold dark:text-white">Team Performance Overview</h2>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <div id="top-achiever-container" class="hidden lg:col-span-1">
                        <div class="gold-card rounded-xl p-5 shadow-lg h-full relative overflow-hidden flex flex-col justify-center">
                            <div class="absolute top-0 right-0 p-4 opacity-20"><i class="fas fa-trophy text-6xl"></i></div>
                            <div class="relative z-10">
                                <div class="text-xs font-bold uppercase tracking-wider mb-1 opacity-80">Top Performer</div>
                                <h2 id="top-name" class="text-2xl font-black tracking-tight leading-none mb-1">-</h2>
                                <p id="top-tl" class="text-sm font-medium opacity-90 mb-4"><span id="top-tl-text">-</span></p>
                                <div class="flex items-end gap-2">
                                    <span class="text-4xl font-black" id="top-score">0%</span>
                                    <span class="text-xs font-bold mb-2 opacity-80 uppercase">Achievement</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="team-grid" class="lg:col-span-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>

                <div class="panel rounded-xl overflow-hidden mt-8">
                    <div class="px-6 py-4 border-b dark:border-slate-700 flex justify-between items-center bg-white dark:bg-slate-800">
                        <h3 class="font-bold text-lg dark:text-white">Agent Rankings</h3>
                        <span class="text-xs font-mono text-slate-500 bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded">SORT: HIGH %</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="text-xs uppercase text-slate-500 font-bold border-b dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50">
                                    <th class="p-4 w-12 text-center">#</th>
                                    <th class="p-4">Agent Name</th>
                                    <th class="p-4">TL</th>
                                    <th class="p-4 text-center">Needed</th>
                                    <th class="p-4 text-center">Current %</th>
                                    <th class="p-4 text-center">KPIs %</th>
                                    <th class="p-4 text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody id="agent-list" class="divide-y dark:divide-slate-700 divide-slate-100 text-sm font-medium dark:text-slate-300"></tbody>
                        </table>
                    </div>
                    <div id="no-results" class="hidden p-12 text-center text-slate-500">
                        <p>No agents found matching your search.</p>
                    </div>
                </div>
            </div>

            <!-- DETAIL VIEW -->
            <div id="view-detail" class="hidden animate-fade-in">
                <button onclick="showMainView()" class="mb-6 text-sm font-bold text-blue-500 hover:text-blue-600 flex items-center group bg-white dark:bg-slate-800 px-4 py-2 rounded-lg shadow-sm w-fit transition">
                    <i class="fas fa-arrow-left mr-2 group-hover:-translate-x-1 transition"></i> Back to Dashboard
                </button>

                <div class="panel rounded-2xl p-8 mb-6 border-l-8 border-blue-500 relative overflow-hidden bg-white dark:bg-slate-800">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center z-10 relative">
                        <div>
                            <h1 id="detail-name" class="text-3xl font-extrabold tracking-tight dark:text-white">-</h1>
                            <p class="text-lg text-slate-500 mt-1 flex items-center"><i class="fas fa-user-circle mr-2"></i> <span id="detail-tl">-</span></p>
                        </div>
                        <div class="mt-4 md:mt-0 text-right">
                            <div class="text-xs text-slate-400 uppercase font-bold tracking-wider mb-1">Total Achievement</div>
                            <div id="detail-main-percent" class="text-5xl font-black text-blue-600 dark:text-blue-400">0%</div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="panel p-6 rounded-xl dark:bg-slate-800">
                        <h3 class="font-bold border-b dark:border-slate-700 pb-3 mb-4 text-blue-500 flex items-center"><i class="fas fa-tachometer-alt mr-2"></i> Core Performance</h3>
                        <div class="space-y-4 text-sm dark:text-slate-300">
                            <div class="flex justify-between"><span>Total Cases</span> <span id="d-total" class="font-bold">0</span></div>
                            <div class="flex justify-between"><span>Achieved Points</span> <span id="d-points" class="font-bold">0</span></div>
                            <div class="flex justify-between"><span>Needed 130%</span> <span id="d-needed" class="font-bold">0</span></div>
                            <div class="flex justify-between"><span>Support</span> <span id="d-support" class="font-bold">0</span></div>
                            <div class="flex justify-between pt-2 border-t dark:border-slate-700"><span>Working Days</span> <span id="d-working-days" class="font-bold text-slate-700 dark:text-slate-200">0</span></div>
                        </div>
                    </div>

                    <div class="panel p-6 rounded-xl dark:bg-slate-800">
                        <h3 class="font-bold border-b dark:border-slate-700 pb-3 mb-4 text-purple-500 flex items-center"><i class="fas fa-chart-pie mr-2"></i> Productivity & SLA</h3>
                        <div class="space-y-5 dark:text-slate-300">
                            <div class="flex justify-between items-center"><span class="text-sm">In Meeting ( >20% )</span><span id="d-meeting" class="font-bold text-sm">-</span></div>
                            <div class="flex justify-between items-center"><span class="text-sm">Off Board</span><span id="d-offboard" class="font-mono font-bold text-sm">-</span></div>
                            <div class="flex justify-between items-center"><span class="text-sm">SLA ( >10% )</span><span id="d-sla" class="font-bold text-sm">-</span></div>
                        </div>
                    </div>

                    <div class="panel p-6 rounded-xl dark:bg-slate-800">
                        <h3 class="font-bold border-b dark:border-slate-700 pb-3 mb-4 text-emerald-500 flex items-center"><i class="fas fa-check-circle mr-2"></i> Compliance</h3>
                        <div class="space-y-5 dark:text-slate-300">
                            <div class="flex justify-between items-center"><span class="text-sm">Quality Score</span><span id="d-quality" class="text-xl font-black">-</span></div>
                            <div class="flex justify-between items-center"><span class="text-sm">Lateness (Max 22m)</span><span id="d-lateness" class="font-bold text-sm">-</span></div>
                            <div class="flex justify-between items-center"><span class="text-sm">SF Lateness (Max 60m)</span><span id="d-sf" class="font-bold text-sm">-</span></div>
                        </div>
                    </div>
                </div>

                <div class="panel rounded-xl overflow-hidden dark:bg-slate-800">
                    <div class="p-4 bg-slate-50 dark:bg-slate-700/50 font-bold border-b dark:border-slate-700 flex items-center text-sm uppercase text-slate-500"><i class="fas fa-list-ul mr-2"></i> Detailed Volume Breakdown</div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-center">
                            <thead class="bg-white dark:bg-slate-800 text-xs uppercase text-slate-400 border-b dark:border-slate-700">
                                <tr>
                                    <th class="p-3">1G SCH</th><th class="p-3">Auto</th><th class="p-3">Check In</th><th class="p-3">DMC</th><th class="p-3">Expired</th>
                                    <th class="p-3">Failed</th><th class="p-3">Manual</th><th class="p-3">Refunds</th><th class="p-3">Reissue</th><th class="p-3">Avg/Day</th>
                                </tr>
                            </thead>
                            <tbody class="font-mono text-base font-semibold dark:text-slate-200">
                                <tr>
                                    <td class="p-4" id="r-1g">0</td><td class="p-4" id="r-auto">0</td><td class="p-4" id="r-checkin">0</td><td class="p-4" id="r-dmc">0</td><td class="p-4" id="r-expired">0</td>
                                    <td class="p-4" id="r-failed">0</td><td class="p-4" id="r-manual">0</td><td class="p-4" id="r-refund">0</td><td class="p-4" id="r-reissue">0</td>
                                    <td class="p-4 font-black text-blue-600 dark:text-blue-400" id="r-avg">0</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // ==========================================
        // PASTE YOUR NEW WEB APP URL HERE
        // ==========================================
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbyz6Z7KEdeZ5sNX6a7G1StdQsuTUbpDKVf4VXDZH0Ji7bnzGO9h-V9nav_vLRZHkfCx/exec'; 
        // ==========================================

        let GLOBAL_DATA = [];

        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.classList.toggle('dark');
            html.classList.toggle('light');
            document.getElementById('theme-icon').className = isDark ? "fas fa-sun" : "fas fa-moon";
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            document.documentElement.classList.remove('light');
            document.getElementById('theme-icon').className = "fas fa-sun";
        }

        async function fetchData() {
            const statusArea = document.getElementById('status-area');
            const refreshIcon = document.getElementById('refresh-icon');
            
            if(GAS_URL.includes('PASTE')) {
                statusArea.innerHTML = `<div class="text-red-500 font-bold">⚠️ URL Missing</div>`;
                return;
            }

            refreshIcon.classList.add('fa-spin');
            
            try {
                const response = await fetch(GAS_URL);
                const data = await response.json();
                
                if(data.error) throw new Error(data.error);

                GLOBAL_DATA = data.agents.sort((a,b) => b.new_pct - a.new_pct);
                
                // Format Date
                const date = new Date(data.last_updated);
                const options = { day: 'numeric', month: 'short', year: '2-digit', hour: '2-digit', minute: '2-digit' };
                document.getElementById('last-updated').innerText = date.toLocaleDateString('en-GB', options);

                statusArea.classList.add('hidden');
                document.getElementById('view-dashboard').classList.remove('hidden');
                renderDashboard();

            } catch (err) {
                statusArea.innerHTML = `<div class="text-red-500 text-center">
                    <div class="text-2xl mb-2">❌ Connection Error</div>
                    <div class="text-sm opacity-80">${err.message}</div>
                </div>`;
            } finally {
                refreshIcon.classList.remove('fa-spin');
            }
        }

        function renderDashboard() {
            const list = document.getElementById('agent-list');
            const teamGrid = document.getElementById('team-grid');
            const searchTerm = (document.getElementById('search-input').value || document.getElementById('mobile-search').value).toLowerCase();
            const noResults = document.getElementById('no-results');
            
            let rows = '';
            const teams = {};
            let filteredCount = 0;

            const filteredData = GLOBAL_DATA.filter(agent => 
                agent.name.toLowerCase().includes(searchTerm) || 
                agent.tl.toLowerCase().includes(searchTerm)
            );

            // Top Achiever
            if(GLOBAL_DATA.length > 0 && searchTerm === '') {
                const top = GLOBAL_DATA[0];
                document.getElementById('top-achiever-container').classList.remove('hidden');
                document.getElementById('top-name').innerText = top.name;
                document.getElementById('top-tl-text').innerText = top.tl;
                document.getElementById('top-score').innerText = Math.round(top.new_pct) + '%';
            } else {
                document.getElementById('top-achiever-container').classList.add('hidden');
            }

            // Team Stats
            GLOBAL_DATA.forEach(agent => {
                 if(!teams[agent.tl]) teams[agent.tl] = { sum:0, count:0 };
                 teams[agent.tl].sum += agent.new_pct;
                 teams[agent.tl].count++;
            });

            // Rows
            filteredData.forEach((agent, i) => {
                filteredCount++;
                const pct = Math.round(agent.new_pct);
                const kpi = Math.round(agent.new_kpi_pct);
                const achClass = pct >= 100 ? 'text-green-600 dark:text-green-400 font-bold' : 'text-slate-600 dark:text-slate-400';
                
                rows += `
                <tr class="group hover:bg-slate-50 dark:hover:bg-slate-700/50 cursor-pointer transition border-b dark:border-slate-800" onclick="showAgentDetail('${agent.name.replace(/'/g, "\\'")}')">
                    <td class="p-4 text-center text-xs opacity-50 font-mono">${i+1}</td>
                    <td class="p-4 font-semibold text-slate-700 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400 transition">${agent.name}</td>
                    <td class="p-4 text-xs opacity-70">${agent.tl}</td>
                    <td class="p-4 text-center font-mono text-slate-500 dark:text-slate-400">${agent.needed}</td>
                    <td class="p-4 text-center text-lg ${achClass}">${pct}%</td>
                    <td class="p-4 text-center opacity-80">${kpi}%</td>
                    <td class="p-4 text-right"><i class="fas fa-chevron-right text-slate-300 group-hover:text-blue-500 transition"></i></td>
                </tr>`;
            });

            list.innerHTML = rows;
            noResults.className = filteredCount === 0 ? "p-12 text-center text-slate-500" : "hidden";

            // Teams
            let teamHtml = '';
            Object.keys(teams)
                .filter(tl => tl.toLowerCase() !== 'unassigned')
                .sort((a, b) => (teams[b].sum / teams[b].count) - (teams[a].sum / teams[a].count))
                .forEach(tl => {
                    const data = teams[tl];
                    const avg = Math.round(data.sum / data.count);
                    let borderClass = avg >= 100 ? 'border-green-500' : (avg < 80 ? 'border-orange-500' : 'border-blue-500');
                    teamHtml += `
                    <div class="panel p-5 rounded-xl border-l-4 ${borderClass} bg-white dark:bg-slate-800 shadow-sm hover:shadow-md transition">
                        <div class="flex justify-between items-start mb-2">
                            <div class="font-bold text-sm truncate pr-2 dark:text-white" title="${tl}">${tl}</div>
                            <span class="text-xs font-mono bg-slate-100 dark:bg-slate-700 px-2 py-0.5 rounded text-slate-500 dark:text-slate-300">${data.count}</span>
                        </div>
                        <div class="flex items-baseline gap-2">
                            <div class="text-2xl font-black tracking-tight dark:text-white">${avg}%</div>
                            <div class="text-xs opacity-50 uppercase font-bold">Avg</div>
                        </div>
                    </div>`;
                });
            teamGrid.innerHTML = teamHtml;
        }

        function showAgentDetail(name) {
            const agent = GLOBAL_DATA.find(a => a.name === name);
            if(!agent) return;

            document.getElementById('detail-name').innerText = agent.name;
            document.getElementById('detail-tl').innerText = agent.tl;
            document.getElementById('detail-main-percent').innerText = Math.round(agent.new_pct) + '%';

            // Core
            document.getElementById('d-total').innerText = agent.total_cases;
            document.getElementById('d-points').innerText = Number(agent.points).toFixed(0);
            document.getElementById('d-needed').innerText = agent.needed;
            document.getElementById('d-support').innerText = agent.support;
            document.getElementById('d-working-days').innerText = agent.work_days;

            // Prod
            setMetric('d-meeting', agent.prod.meeting + '%', parseFloat(agent.prod.meeting) > 20, false);
            document.getElementById('d-offboard').innerText = agent.prod.offboard + '%';
            setMetric('d-sla', agent.sla + '%', parseFloat(agent.sla) > 10, false);

            // Compliance
            const qEl = document.getElementById('d-quality');
            qEl.innerText = agent.quality + '%';
            qEl.className = `text-xl font-black ${parseFloat(agent.quality) >= 90 ? 'text-green-500' : 'text-orange-500'}`;

            setMetric('d-lateness', agent.lateness + 'm', agent.lateness > 22, true);
            setMetric('d-sf', agent.sf_lateness + 'm', agent.sf_lateness > 60, true);

            // Raw Cases
            document.getElementById('r-1g').innerText = agent.cases['1g'];
            document.getElementById('r-auto').innerText = agent.cases['auto'];
            document.getElementById('r-checkin').innerText = agent.cases['checkin'];
            document.getElementById('r-dmc').innerText = agent.cases['dmc'];
            document.getElementById('r-expired').innerText = agent.cases['expired'];
            document.getElementById('r-failed').innerText = agent.cases['failed'];
            document.getElementById('r-manual').innerText = agent.cases['manual'];
            document.getElementById('r-refund').innerText = agent.cases['refund'];
            document.getElementById('r-reissue').innerText = agent.cases['reissue'];
            document.getElementById('r-avg').innerText = agent.cases['avg'];

            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-detail').classList.remove('hidden');
            window.scrollTo(0,0);
        }

        function showMainView() {
            document.getElementById('view-dashboard').classList.remove('hidden');
            document.getElementById('view-detail').classList.add('hidden');
            renderDashboard();
            window.scrollTo(0,0);
        }

        function setMetric(id, value, isDanger, isGoodGreen) {
            const el = document.getElementById(id);
            el.innerText = value;
            if(isDanger) {
                el.className = 'px-3 py-1 rounded font-bold text-sm bg-red-100 text-red-600 border border-red-200 dark:bg-red-900/30 dark:border-red-800 dark:text-red-400';
            } else {
                el.className = isGoodGreen 
                    ? 'px-3 py-1 rounded font-bold text-sm bg-green-100 text-green-600 border border-green-200 dark:bg-green-900/30 dark:border-green-800 dark:text-green-400' 
                    : 'font-bold text-slate-600 dark:text-slate-300 text-sm';
            }
        }
        
        fetchData();
    </script>
</body>
</html>