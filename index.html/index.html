<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFT Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { 
                extend: { 
                    colors: { 
                        dark: { 900: '#0f172a', 800: '#1e293b', 700: '#334155' },
                        brand: { 500: '#3b82f6', 600: '#2563eb' }
                    } 
                } 
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }

        .panel { transition: all 0.3s ease; }
        .light body { background-color: #f1f5f9; color: #0f172a; }
        .dark body { background-color: #0f172a; color: #f8fafc; }
        
        .light .panel { background: white; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .dark .panel { background: #1e293b; border: 1px solid #334155; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3); }

        .gold-card { background: linear-gradient(135deg, #FFD700 0%, #FDB931 100%); color: #5c4d00; }
        .dark .gold-card { background: linear-gradient(135deg, #B8860B 0%, #8B6508 100%); color: #fff; }

        /* Loader */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="overflow-hidden h-screen flex flex-col">

    <!-- NEW HEADER AS REQUESTED -->
    <header class="bg-[#0f172a] text-white flex-shrink-0 z-50 shadow-md">
        <div class="h-16 px-6 flex items-center justify-between">
            
            <!-- Left: Logo & Title -->
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center shadow-lg shadow-blue-500/30">
                    <i class="fas fa-chart-simple text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold leading-tight tracking-wide">FFT Dashboard</h1>
                    <p class="text-xs text-slate-400 font-medium">Fulfillment Air Agents</p>
                </div>
            </div>

            <!-- Center: Search Bar -->
            <div class="hidden md:block flex-1 max-w-md mx-8">
                <div class="relative group">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-slate-500 group-focus-within:text-blue-400 transition"></i>
                    </div>
                    <input type="text" id="search-input" onkeyup="renderDashboard()" 
                        class="block w-full pl-10 pr-3 py-2 border border-slate-700 rounded-lg leading-5 bg-slate-800 text-slate-200 placeholder-slate-500 focus:outline-none focus:bg-slate-900 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-colors" 
                        placeholder="Search agents, TLs...">
                </div>
            </div>

            <!-- Right: Stats & Controls -->
            <div class="flex items-center gap-4">
                <!-- Last Updated Pill -->
                <div class="hidden lg:flex items-center bg-slate-800 rounded-full px-3 py-1.5 border border-slate-700">
                    <i class="far fa-clock text-slate-400 text-xs mr-2"></i>
                    <span class="text-xs text-slate-300 font-mono" id="last-updated">Syncing...</span>
                </div>

                <!-- Refresh Button -->
                <button onclick="fetchData()" class="p-2 text-slate-400 hover:text-white transition" title="Refresh Data">
                    <i class="fas fa-sync-alt" id="refresh-icon"></i>
                </button>

                <!-- Theme Toggle -->
                <button onclick="toggleTheme()" class="p-2 text-slate-400 hover:text-yellow-400 transition" title="Toggle Theme">
                    <i class="fas fa-sun" id="theme-icon"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Sub-header for Mobile Search -->
    <div class="md:hidden bg-[#0f172a] px-6 pb-4 border-b border-slate-800">
        <input type="text" onkeyup="renderDashboard()" id="mobile-search"
            class="block w-full px-4 py-2 border border-slate-700 rounded-lg bg-slate-800 text-slate-200 placeholder-slate-500 focus:outline-none focus:border-blue-500 sm:text-sm" 
            placeholder="Search agents...">
    </div>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-y-auto relative scroll-smooth bg-gray-50 dark:bg-[#0b1120]">
        
        <div class="p-6 max-w-[1920px] mx-auto space-y-6">
            
            <!-- Loading State -->
            <div id="status-area" class="flex flex-col items-center justify-center h-[60vh]">
                <div class="loader mb-4"></div>
                <p class="text-sm font-medium text-slate-500 animate-pulse">Connecting to Google Sheets...</p>
            </div>

            <!-- VIEW 1: DASHBOARD -->
            <div id="view-dashboard" class="hidden space-y-6">
                
                <!-- Section Header -->
                <div class="flex items-center gap-2 mb-2">
                    <i class="fas fa-chart-line text-blue-500"></i>
                    <h2 class="text-xl font-bold dark:text-white">Team Performance Overview</h2>
                </div>

                <!-- Top Achiever & Team Stats -->
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <!-- Top Achiever Card -->
                    <div id="top-achiever-container" class="hidden lg:col-span-1">
                        <div class="gold-card rounded-xl p-5 shadow-lg h-full relative overflow-hidden flex flex-col justify-center">
                            <div class="absolute top-0 right-0 p-4 opacity-20"><i class="fas fa-trophy text-6xl"></i></div>
                            <div class="relative z-10">
                                <div class="text-xs font-bold uppercase tracking-wider mb-1 opacity-80">Top Performer</div>
                                <h2 id="top-name" class="text-2xl font-black tracking-tight leading-none mb-1">Agent Name</h2>
                                <p id="top-tl" class="text-sm font-medium opacity-90 mb-4"><i class="fas fa-user-tie mr-1"></i><span id="top-tl-text">TL Name</span></p>
                                <div class="flex items-end gap-2">
                                    <span class="text-4xl font-black" id="top-score">0%</span>
                                    <span class="text-xs font-bold mb-2 opacity-80 uppercase">Achievement</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Team Stats Container -->
                    <div id="team-grid" class="lg:col-span-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <!-- Agent Table -->
                <div class="panel rounded-xl overflow-hidden mt-8">
                    <div class="px-6 py-4 border-b dark:border-slate-700 flex justify-between items-center bg-white dark:bg-slate-800">
                        <h3 class="font-bold text-lg dark:text-white">Agent Rankings</h3>
                        <span class="text-xs font-mono text-slate-500 bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded">SORT: HIGH %</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="text-xs uppercase text-slate-500 font-bold border-b dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50">
                                    <th class="p-4 w-12 text-center">#</th>
                                    <th class="p-4">Agent Name</th>
                                    <th class="p-4">TL</th>
                                    <th class="p-4 text-center">Needed (130%)</th>
                                    <th class="p-4 text-center">Current %</th>
                                    <th class="p-4 text-center">KPIs %</th>
                                    <th class="p-4 text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody id="agent-list" class="divide-y dark:divide-slate-700 divide-slate-100 text-sm font-medium dark:text-slate-300"></tbody>
                        </table>
                    </div>
                    <div id="no-results" class="hidden p-12 text-center text-slate-500">
                        <i class="fas fa-search mb-2 text-2xl opacity-50"></i>
                        <p>No agents found matching your search.</p>
                    </div>
                </div>
            </div>

            <!-- VIEW 2: AGENT DETAIL -->
            <div id="view-detail" class="hidden animate-fade-in">
                <button onclick="showMainView()" class="mb-6 text-sm font-bold text-blue-500 hover:text-blue-600 flex items-center group bg-white dark:bg-slate-800 px-4 py-2 rounded-lg shadow-sm w-fit transition">
                    <i class="fas fa-arrow-left mr-2 group-hover:-translate-x-1 transition"></i> Back to Dashboard
                </button>

                <!-- Header Card -->
                <div class="panel rounded-2xl p-8 mb-6 border-l-8 border-blue-500 relative overflow-hidden bg-white dark:bg-slate-800">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center z-10 relative">
                        <div>
                            <h1 id="detail-name" class="text-3xl font-extrabold tracking-tight dark:text-white">Agent Name</h1>
                            <p class="text-lg text-slate-500 mt-1 flex items-center"><i class="fas fa-user-circle mr-2"></i> <span id="detail-tl">Team Leader</span></p>
                        </div>
                        <div class="mt-4 md:mt-0 text-right">
                            <div class="text-xs text-slate-400 uppercase font-bold tracking-wider mb-1">Total Achievement</div>
                            <div id="detail-main-percent" class="text-5xl font-black text-blue-600 dark:text-blue-400">0%</div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <!-- Col 1: Core -->
                    <div class="panel p-6 rounded-xl dark:bg-slate-800">
                        <h3 class="font-bold border-b dark:border-slate-700 pb-3 mb-4 text-blue-500 flex items-center">
                            <i class="fas fa-tachometer-alt mr-2"></i> Core Performance
                        </h3>
                        <div class="space-y-4 text-sm dark:text-slate-300">
                            <div class="flex justify-between"><span>Total Cases</span> <span id="d-total" class="font-bold">0</span></div>
                            <div class="flex justify-between"><span>Achieved Points</span> <span id="d-points" class="font-bold">0</span></div>
                            <div class="flex justify-between"><span>Needed 130%</span> <span id="d-needed" class="font-bold">0</span></div>
                            <div class="flex justify-between"><span>Support</span> <span id="d-support" class="font-bold">0</span></div>
                            <!-- NEW FIELD ADDED HERE -->
                            <div class="flex justify-between pt-2 border-t dark:border-slate-700">
                                <span>Working Days</span> 
                                <span id="d-working-days" class="font-bold text-slate-700 dark:text-slate-200">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Col 2: Prod -->
                    <div class="panel p-6 rounded-xl dark:bg-slate-800">
                        <h3 class="font-bold border-b dark:border-slate-700 pb-3 mb-4 text-purple-500 flex items-center">
                            <i class="fas fa-chart-pie mr-2"></i> Productivity & SLA
                        </h3>
                        <div class="space-y-5 dark:text-slate-300">
                            <div class="flex justify-between items-center">
                                <span class="text-sm">In Meeting ( >20% )</span>
                                <span id="d-meeting" class="px-3 py-1 rounded font-bold text-sm">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm">Off Board</span>
                                <span id="d-offboard" class="font-mono font-bold text-sm">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm">SLA ( >10% )</span>
                                <span id="d-sla" class="px-3 py-1 rounded font-bold text-sm">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Col 3: Compliance -->
                    <div class="panel p-6 rounded-xl dark:bg-slate-800">
                        <h3 class="font-bold border-b dark:border-slate-700 pb-3 mb-4 text-emerald-500 flex items-center">
                            <i class="fas fa-check-circle mr-2"></i> Compliance
                        </h3>
                        <div class="space-y-5 dark:text-slate-300">
                            <div class="flex justify-between items-center">
                                <span class="text-sm">Quality Score</span>
                                <span id="d-quality" class="text-xl font-black">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm">Lateness (Max 22m)</span>
                                <span id="d-lateness" class="px-3 py-1 rounded font-bold text-sm">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm">SF Lateness (Max 60m)</span>
                                <span id="d-sf" class="px-3 py-1 rounded font-bold text-sm">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Raw Data Table -->
                <div class="panel rounded-xl overflow-hidden dark:bg-slate-800">
                    <div class="p-4 bg-slate-50 dark:bg-slate-700/50 font-bold border-b dark:border-slate-700 flex items-center text-sm uppercase text-slate-500">
                        <i class="fas fa-list-ul mr-2"></i> Detailed Volume Breakdown
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-center">
                            <thead class="bg-white dark:bg-slate-800 text-xs uppercase text-slate-400 border-b dark:border-slate-700">
                                <tr>
                                    <th class="p-3">1G SCH</th>
                                    <th class="p-3">Auto</th>
                                    <th class="p-3">Check In</th>
                                    <th class="p-3">DMC</th>
                                    <th class="p-3">Expired</th>
                                    <th class="p-3">Failed</th>
                                    <th class="p-3">Manual</th>
                                    <th class="p-3">Refunds</th>
                                    <th class="p-3">Reissue</th>
                                    <th class="p-3">Avg/Day</th>
                                </tr>
                            </thead>
                            <tbody class="font-mono text-base font-semibold dark:text-slate-200">
                                <tr>
                                    <td class="p-4" id="r-1g">0</td>
                                    <td class="p-4" id="r-auto">0</td>
                                    <td class="p-4" id="r-checkin">0</td>
                                    <td class="p-4" id="r-dmc">0</td>
                                    <td class="p-4" id="r-expired">0</td>
                                    <td class="p-4" id="r-failed">0</td>
                                    <td class="p-4" id="r-manual">0</td>
                                    <td class="p-4" id="r-refund">0</td>
                                    <td class="p-4" id="r-reissue">0</td>
                                    <td class="p-4 font-black text-blue-600 dark:text-blue-400" id="r-avg">0</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        // ==========================================
        // 1. PASTE YOUR WEB APP URL HERE FROM APP SCRIPTS
        // ==========================================
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwqtw0OiM3crxfSyFHsghy3qJNOjOmyVFzqudfac8mP85yCZAJCC5kOhNR9CYl8mzs/exec'; 
        // Example: 'https://script.google.com/macros/s/AKfycbx.../exec'
        // ==========================================

        let GLOBAL_DATA = [];

        // Theme Logic
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.classList.toggle('dark');
            html.classList.toggle('light');
            document.getElementById('theme-icon').className = isDark ? "fas fa-sun" : "fas fa-moon";
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }
        // Initialize Theme
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            document.documentElement.classList.remove('light');
            document.getElementById('theme-icon').className = "fas fa-sun";
        }

        // Data Helpers
        function cleanNum(val) {
            if(!val) return 0;
            const n = parseFloat(String(val).replace('%', '').trim());
            return isNaN(n) ? 0 : n;
        }

        async function fetchData() {
            const statusArea = document.getElementById('status-area');
            const refreshIcon = document.getElementById('refresh-icon');
            
            if(GAS_URL.includes('PASTE_YOUR')) {
                statusArea.innerHTML = `<div class="text-red-500 font-bold text-xl">⚠️ Configuration Missing</div><div class="mt-2 text-slate-500">Please paste your Google Apps Script Web App URL in the code.</div>`;
                return;
            }

            refreshIcon.classList.add('fa-spin');
            
            try {
                // Fetch JSON from Google Apps Script
                const response = await fetch(GAS_URL);
                const json = await response.json();
                
                // Process the data object returned by GAS
                processData(json);
                
                document.getElementById('last-updated').innerText = new Date().toLocaleTimeString();
                statusArea.classList.add('hidden');
                document.getElementById('view-dashboard').classList.remove('hidden');

            } catch (err) {
                console.error(err);
                statusArea.innerHTML = `<div class="text-red-500 font-bold text-xl">❌ Sync Failed</div><div class="text-slate-500 mt-2 text-sm">${err.message}</div>`;
            } finally {
                refreshIcon.classList.remove('fa-spin');
            }
        }

        function processData(data) {
            const map = {};
            const emailToName = {};
            const nameVariations = {}; 

            // 1. Build Email Map
            data.mapping.forEach(row => {
                const name = row['Name']?.trim();
                const email = row['Email Address']?.trim().toLowerCase();
                if(name && email) {
                    emailToName[email] = name;
                    nameVariations[name.toLowerCase()] = name;
                }
            });

            // Helper to find matching name
            function findMatchingName(searchName) {
                if(!searchName) return null;
                const lower = searchName.trim().toLowerCase();
                // Check direct map
                if(map[searchName]) return searchName;
                // Check case insensitive
                if(nameVariations[lower] && map[nameVariations[lower]]) return nameVariations[lower];
                return null;
            }

            // Helper to resolve name from any row
            function resolveName(row, nameCol, emailCol) {
                let name = row[nameCol]?.trim();
                if(name) {
                    const matched = findMatchingName(name);
                    if(matched) return matched;
                    // If name exists but not in main map yet (and this isn't main processing), skip
                }
                
                if(emailCol) {
                    let email = (row[emailCol] || '').trim().toLowerCase();
                    if(email && emailToName[email]) {
                        const matched = findMatchingName(emailToName[email]);
                        if(matched) return matched;
                    }
                }
                return null;
            }

            // 2. Main Data
            data.main.forEach(row => {
                const name = row['Agent Name']?.trim();
                if(!name) return;

                map[name] = {
                    ...row,
                    name: name,
                    tl: row['TL'] || 'Unassigned',
                    percentRaw: cleanNum(row['New %']),
                    percentStr: row['New %'] || '0%',
                    kpiStr: row['New KPIs %'] || '0%',
                    needed: row['Needed Points 130%'] || '0',
                    // New Working Days Field
                    workingDays: row['Working Days'] || row['WorkingDays'] || row['Days'] || '0',
                    inMeeting: 0, offBoard: 0, sla: 0, quality: 0, lateness: 0, sfLateness: 0
                };
                nameVariations[name.toLowerCase()] = name;
            });

            // 3. Productivity
            data.prod.forEach(row => {
                const email = (row['Email'] || row['email'] || row['Email Address'])?.trim().toLowerCase();
                let targetName = null;
                
                if(email && emailToName[email]) targetName = emailToName[email];
                
                if(targetName && map[targetName]) {
                    const meetingMins = cleanNum(row['In_a_Meeting'] || row['In Meeting']);
                    const offBoardMins = cleanNum(row['Off_Board'] || row['Off Board']);
                    const totalMins = cleanNum(row['Total'] || row['total']);

                    if(totalMins > 0) {
                        map[targetName].inMeeting = ((meetingMins / totalMins) * 100).toFixed(1);
                        map[targetName].offBoard = ((offBoardMins / totalMins) * 100).toFixed(1);
                    }
                }
            });

            // 4. SLA
            data.sla.forEach(row => {
                const n = resolveName(row, 'Case History Owner', null);
                if(n && map[n]) map[n].sla = cleanNum(row['Percentage'] || row['SLA']);
            });

            // 5. Quality
            data.quality.forEach(row => {
                const n = resolveName(row, 'Name of the Agent', null);
                if(n && map[n]) map[n].quality = cleanNum(row['Percentage'] || row['Quality Score']);
            });

            // 6. Lateness
            data.lateness.forEach(row => {
                const n = resolveName(row, 'Name', null);
                if(n && map[n]) map[n].lateness = cleanNum(row['SUM of Lateness'] || row['Lateness']);
            });

            // 7. SF Lateness
            data.sf.forEach(row => {
                const n = resolveName(row, 'Agent Name', null);
                if(n && map[n]) map[n].sfLateness = cleanNum(row['Lateness (Max 60 Min)'] || row['SF Lateness']);
            });

            // Convert to Array & Sort
            GLOBAL_DATA = Object.values(map).sort((a,b) => b.percentRaw - a.percentRaw);
            renderDashboard();
        }

        function renderDashboard() {
            const list = document.getElementById('agent-list');
            const teamGrid = document.getElementById('team-grid');
            
            // Sync both search bars
            const desktopSearch = document.getElementById('search-input').value.toLowerCase();
            const mobileSearch = document.getElementById('mobile-search').value.toLowerCase();
            const searchTerm = desktopSearch || mobileSearch;
            
            const noResults = document.getElementById('no-results');
            
            let rows = '';
            const teams = {};
            let filteredCount = 0;

            const filteredData = GLOBAL_DATA.filter(agent => 
                agent.name.toLowerCase().includes(searchTerm) || 
                agent.tl.toLowerCase().includes(searchTerm)
            );

            // Top Achiever Logic
            if(GLOBAL_DATA.length > 0 && searchTerm === '') {
                const top = GLOBAL_DATA[0];
                document.getElementById('top-achiever-container').classList.remove('hidden');
                document.getElementById('top-name').innerText = top.name;
                document.getElementById('top-tl-text').innerText = top.tl;
                document.getElementById('top-score').innerText = top.percentStr;
            } else {
                document.getElementById('top-achiever-container').classList.add('hidden');
            }

            // Team Stats Calculation
            GLOBAL_DATA.forEach(agent => {
                 if(!teams[agent.tl]) teams[agent.tl] = { sum:0, count:0 };
                 teams[agent.tl].sum += agent.percentRaw;
                 teams[agent.tl].count++;
            });

            // Render Rows
            filteredData.forEach((agent, i) => {
                filteredCount++;
                const achClass = agent.percentRaw >= 100 ? 'text-green-600 dark:text-green-400 font-bold' : 'text-slate-600 dark:text-slate-400';
                rows += `
                <tr class="group hover:bg-slate-50 dark:hover:bg-slate-700/50 cursor-pointer transition border-b dark:border-slate-800" onclick="showAgentDetail('${agent.name.replace(/'/g, "\\'")}')">
                    <td class="p-4 text-center text-xs opacity-50 font-mono">${i+1}</td>
                    <td class="p-4 font-semibold text-slate-700 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400 transition">${agent.name}</td>
                    <td class="p-4 text-xs opacity-70">${agent.tl}</td>
                    <td class="p-4 text-center font-mono text-slate-500 dark:text-slate-400">${agent.needed}</td>
                    <td class="p-4 text-center text-lg ${achClass}">${agent.percentStr}</td>
                    <td class="p-4 text-center opacity-80">${agent.kpiStr}</td>
                    <td class="p-4 text-right">
                        <i class="fas fa-chevron-right text-slate-300 group-hover:text-blue-500 transition"></i>
                    </td>
                </tr>`;
            });

            list.innerHTML = rows;
            
            if(filteredCount === 0) {
                noResults.classList.remove('hidden');
            } else {
                noResults.classList.add('hidden');
            }

            // Render Teams
            let teamHtml = '';
            const sortedTeams = Object.keys(teams)
                .filter(tl => tl.toLowerCase() !== 'unassigned')
                .sort((a, b) => (teams[b].sum / teams[b].count) - (teams[a].sum / teams[a].count));

            sortedTeams.forEach(tl => {
                const data = teams[tl];
                const avg = (data.sum / data.count).toFixed(1);
                
                let borderClass = 'border-l-4 border-blue-500';
                if(avg >= 100) borderClass = 'border-l-4 border-green-500';
                else if(avg < 80) borderClass = 'border-l-4 border-orange-500';

                teamHtml += `
                <div class="panel p-5 rounded-xl ${borderClass} bg-white dark:bg-slate-800 shadow-sm hover:shadow-md transition">
                    <div class="flex justify-between items-start mb-2">
                        <div class="font-bold text-sm truncate pr-2 dark:text-white" title="${tl}">${tl}</div>
                        <span class="text-xs font-mono bg-slate-100 dark:bg-slate-700 px-2 py-0.5 rounded text-slate-500 dark:text-slate-300">${data.count}</span>
                    </div>
                    <div class="flex items-baseline gap-2">
                        <div class="text-2xl font-black tracking-tight dark:text-white">${avg}%</div>
                        <div class="text-xs opacity-50 uppercase font-bold">Avg</div>
                    </div>
                </div>`;
            });
            teamGrid.innerHTML = teamHtml;
        }

        function showAgentDetail(name) {
            const agent = GLOBAL_DATA.find(a => a.name === name);
            if(!agent) return;

            document.getElementById('detail-name').innerText = agent.name;
            document.getElementById('detail-tl').innerText = agent.tl;
            document.getElementById('detail-main-percent').innerText = agent.percentStr;

            // Core
            document.getElementById('d-total').innerText = agent['Total'] || 0;
            document.getElementById('d-points').innerText = agent['Achieved Points'] || 0;
            document.getElementById('d-needed').innerText = agent['Needed Points 130%'] || 0;
            document.getElementById('d-support').innerText = agent['Support'] || 0;
            
            // Populate Working Days
            document.getElementById('d-working-days').innerText = agent.workingDays || 0;

            // Prod / SLA
            setMetric('d-meeting', agent.inMeeting + '%', parseFloat(agent.inMeeting) > 20, false);
            document.getElementById('d-offboard').innerText = agent.offBoard + '%';
            setMetric('d-sla', agent.sla + '%', parseFloat(agent.sla) > 10, false);

            // Compliance
            const qEl = document.getElementById('d-quality');
            qEl.innerText = agent.quality + '%';
            qEl.className = `text-xl font-black ${agent.quality >= 90 ? 'text-green-500' : 'text-orange-500'}`;

            setMetric('d-lateness', agent.lateness + 'm', agent.lateness > 22, true);
            setMetric('d-sf', agent.sfLateness + 'm', agent.sfLateness > 60, true);

            // Raw
            const rawMap = {'1G SCH': 'r-1g', 'Auto': 'r-auto', 'Check In': 'r-checkin', 'DMC': 'r-dmc', 'Expired Payment': 'r-expired', 'Failed': 'r-failed', 'Manual': 'r-manual', 'Reissue /Refunds': 'r-refund', 'Refund Others': 'r-reissue', 'AVG Cases Per Day': 'r-avg'};
            for (const [key, id] of Object.entries(rawMap)) {
                document.getElementById(id).innerText = agent[key] || 0;
            }

            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-detail').classList.remove('hidden');
            window.scrollTo(0,0);
        }

        function showMainView() {
            document.getElementById('view-dashboard').classList.remove('hidden');
            document.getElementById('view-detail').classList.add('hidden');
            renderDashboard();
            window.scrollTo(0,0);
        }

        function setMetric(id, value, isDanger, isGoodGreen) {
            const el = document.getElementById(id);
            el.innerText = value;
            if(isDanger) {
                el.className = 'px-3 py-1 rounded font-bold text-sm bg-red-100 text-red-600 border border-red-200 dark:bg-red-900/30 dark:border-red-800 dark:text-red-400';
            } else {
                el.className = isGoodGreen 
                    ? 'px-3 py-1 rounded font-bold text-sm bg-green-100 text-green-600 border border-green-200 dark:bg-green-900/30 dark:border-green-800 dark:text-green-400' 
                    : 'font-bold text-slate-600 dark:text-slate-300 text-sm';
            }
        }

        // Init
        fetchData();
    </script>
</body>
</html>